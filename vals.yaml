# vals.yaml

server:
  workers: 1
  node:
    environment: production
    dataDir: /data/trino
    pluginDir: /usr/lib/trino/plugin
  log:
    trino:
      level: INFO
  config:
    path: /etc/trino
    https:
      enabled: true   # Включаем HTTPS
      port: 8443     # Используем стандартный порт для HTTPS
      keystore:
        path: "/opt/trino/cert.pem"  # Путь к сертификату в формате PEM
    authenticationType: ""           # Оставляем пустое значение, если аутентификация не настроена
    query:
      maxMemory: "4GB"
  exchangeManager: {}


coordinator:
  secretMounts:
    - name: trino-certs
      secretName: trino-certs
      path: /opt/trino/cert.pem
      subPath: cert.pem

  extraVolumes:
    - name: access-control
      configMap:
        name: trino-access-control

  extraVolumeMounts:
    - name: access-control
      mountPath: /etc/trino/access-control
  


worker:
  secretMounts:
    - name: trino-certs
      secretName: trino-certs
      path: /opt/trino/cert.pem
      subPath: cert.pem

  extraVolumes:
    - name: access-control
      configMap:
        name: trino-access-control
  extraVolumeMounts:
    - name: access-control
      mountPath: /etc/trino/access-control
   


accessControl:
  type: configmap
  refreshPeriod: 60s
  configFile: "rules.json"
  rules:
    rules.json: |-
      {
        "catalogs": [
          {
            "user": "trino",
            "catalog": ".*",
            "allow": "all"
          },
          {
            "group": "finance|human_resources",
            "catalog": "postgres",
            "allow": true
          },
          {
            "catalog": "hive",
            "allow": "all"
          },
          {
            "user": "yandex",
            "catalog": "postgresql",
            "allow": "read-only"
          },
          {
            "catalog": "system",
            "allow": "none"
          }
        ],
        "schemas": [
          {
            "user": "admin",
            "schema": ".*",
            "owner": true
          },
          {
            "user": "guest",
            "owner": false
          },
          {
            "catalog": "default",
            "schema": "default",
            "owner": true
          }
        ]
      }

ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"

  hosts:
    - host: trino.k8c.ru
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: trino
              port:
                number: 8080
  tls:
    - secretName: trino-tls-secret
      hosts:
        - trino.k8c.ru

additionalConfigProperties:
  - http-server.process-forwarded=true
  # - http-server.https.enabled=true