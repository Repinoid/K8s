{{- if not .Values.config.existingConfigmap }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "postgres.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "postgres.labels" . | nindent 4 }}
  {{- if .Values.commonAnnotations }}
  annotations:
    {{- include "postgres.annotations" . | nindent 4 }}
  {{- end }}
data:
  pg_hba.conf: |
{{- if .Values.config.pgHbaConfig }}
{{ .Values.config.pgHbaConfig | indent 4 }}
{{- else }}
    # Default pg_hba.conf configuration
    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # "local" is for Unix domain socket connections only
    local   all             all                                     trust
    # IPv4 local connections:
    host    all             all             127.0.0.1/32            trust
    # IPv6 local connections:
    host    all             all             ::1/128                 trust
    # Allow replication connections from localhost, by a user with the
    # replication privilege.
    local   replication     all                                     trust
    host    replication     all             127.0.0.1/32            trust
    host    replication     all             ::1/128                 trust

    # Allow connections from any host with password authentication
    host    all             all             all                     md5
{{- end }}
  postgresql.conf: |
    # PostgreSQL configuration file

    # Connection Settings
    listen_addresses = '*'
    {{- if .Values.config.postgresqlMaxConnections }}
    max_connections = {{ .Values.config.postgresqlMaxConnections }}
    {{- else }}
    max_connections = 100
    {{- end }}
    
    # Memory Settings
    {{- if .Values.config.postgresqlSharedBuffers }}
    shared_buffers = {{ .Values.config.postgresqlSharedBuffers }}
    {{- else }}
    shared_buffers = 128MB
    {{- end }}
    
    {{- if .Values.config.postgresqlEffectiveCacheSize }}
    effective_cache_size = {{ .Values.config.postgresqlEffectiveCacheSize }}
    {{- else }}
    effective_cache_size = 4GB
    {{- end }}
    
    {{- if .Values.config.postgresqlWorkMem }}
    work_mem = {{ .Values.config.postgresqlWorkMem }}
    {{- else }}
    work_mem = 4MB
    {{- end }}
    
    {{- if .Values.config.postgresqlMaintenanceWorkMem }}
    maintenance_work_mem = {{ .Values.config.postgresqlMaintenanceWorkMem }}
    {{- else }}
    maintenance_work_mem = 64MB
    {{- end }}
    
    # WAL Settings
    {{- if .Values.config.postgresqlWalBuffers }}
    wal_buffers = {{ .Values.config.postgresqlWalBuffers }}
    {{- else }}
    wal_buffers = 16MB
    {{- end }}
    
    # Checkpoint Settings
    {{- if .Values.config.postgresqlCheckpointCompletionTarget }}
    checkpoint_completion_target = {{ .Values.config.postgresqlCheckpointCompletionTarget }}
    {{- else }}
    checkpoint_completion_target = 0.7
    {{- end }}
    
    # Query Planner Settings
    {{- if .Values.config.postgresqlRandomPageCost }}
    random_page_cost = {{ .Values.config.postgresqlRandomPageCost }}
    {{- else }}
    random_page_cost = 1.1
    {{- end }}
    
    # Logging Settings
    log_destination = 'stderr'
    logging_collector = off
    log_min_messages = warning
    log_min_error_statement = error
    
    {{- if .Values.config.postgresqlLogStatement }}
    log_statement = {{ .Values.config.postgresqlLogStatement | squote }}
    {{- else }}
    log_statement = 'none'
    {{- end }}
    
    {{- if .Values.config.postgresqlLogMinDurationStatement }}
    log_min_duration_statement = {{ .Values.config.postgresqlLogMinDurationStatement }}
    {{- else }}
    log_min_duration_statement = -1
    {{- end }}
    
    # Shared Libraries
    {{- if .Values.config.postgresqlSharedPreloadLibraries }}
    shared_preload_libraries = {{ .Values.config.postgresqlSharedPreloadLibraries | squote }}
    {{- end }}
    
    # Locale and Formatting
    datestyle = 'iso, mdy'
    timezone = 'UTC'
    lc_messages = 'en_US.utf8'
    lc_monetary = 'en_US.utf8'
    lc_numeric = 'en_US.utf8'
    lc_time = 'en_US.utf8'
    default_text_search_config = 'pg_catalog.english'
    
    # Set pg_hba.conf file to use
    hba_file = '{{ include "postgres.configDir" . }}/pg_hba.conf'

    # Additional Configuration
    {{- range .Values.config.extraConfig }}
    {{ . }}
    {{- end }}
{{- end }}